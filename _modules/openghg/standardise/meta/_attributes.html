
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>openghg.standardise.meta._attributes &#8212; OpenGHG 0+untagged.3.g308efeb documentation</title>
    
    <link href="../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    
    <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/custom.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../../index.html">
<p class="title">OpenGHG</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../features.html">
  Features
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../install.html">
  Installation instructions
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../tutorials/index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../development/index_devel.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../api/index.html">
  User API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../api/index_devapi.html">
  Developer API
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for openghg.standardise.meta._attributes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">xarray</span> <span class="kn">import</span> <span class="n">Dataset</span>


<div class="viewcode-block" id="assign_attributes"><a class="viewcode-back" href="../../../../api/api_standardise.html#openghg.standardise.meta.assign_attributes">[docs]</a><span class="k">def</span> <span class="nf">assign_attributes</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sampling_period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Assign attributes to each site and species dataset. This ensures that the xarray Datasets produced</span>
<span class="sd">    are CF 1.7 compliant. Some of the attributes written to the Dataset are saved as metadata</span>
<span class="sd">    to the Datasource allowing more detailed searching of data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Dictionary containing data, metadata and attributes</span>
<span class="sd">        site: Site code</span>
<span class="sd">        sampling_period: Number of seconds for which air</span>
<span class="sd">                         sample is taken. Only for time variable attribute</span>
<span class="sd">        network: Network name</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary of combined data with correct attributes assigned to Datasets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">openghg.standardise.meta</span> <span class="kn">import</span> <span class="n">surface_standardise</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">gas_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">site_attributes</span> <span class="o">=</span> <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>

        <span class="n">units</span> <span class="o">=</span> <span class="n">gas_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">gas_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sampling_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sampling_period</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gas_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sampling_period&quot;</span><span class="p">))</span>

        <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">=</span><span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
            <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
            <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">global_attributes</span><span class="o">=</span><span class="n">site_attributes</span><span class="p">,</span>
            <span class="n">sampling_period</span><span class="o">=</span><span class="n">sampling_period</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">measurement_data</span> <span class="o">=</span> <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="o">.</span><span class="n">attrs</span>

        <span class="n">gas_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_standardise</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_attributes"><a class="viewcode-back" href="../../../../api/api_standardise.html#openghg.standardise.meta.get_attributes">[docs]</a><span class="k">def</span> <span class="nf">get_attributes</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">global_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sampling_period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">date_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function writes attributes to an xarray.Dataset so that they conform with</span>
<span class="sd">    the CF Convention v1.6</span>

<span class="sd">    Attributes of the xarray DataSet are modified, and variable names are changed</span>

<span class="sd">    If the species is a standard mole fraction then either:</span>
<span class="sd">        - species name will used in lower case in the file and variable names</span>
<span class="sd">            but with any hyphens taken out</span>
<span class="sd">        - name will be changed according to the species_translator dictionary</span>

<span class="sd">    If the species is isotopic data or a non-standard variable (e.g. APO):</span>
<span class="sd">        - Isotopes species names should begin with a &quot;D&quot;</span>
<span class="sd">            (Annoyingly, the code currently picks up &quot;Desflurane&quot; too. I&#39;ve</span>
<span class="sd">             fixed this for now, but if we get a lot of other &quot;D&quot; species, we</span>
<span class="sd">             should make this better)</span>
<span class="sd">        - I suggest naming for isotopologues should be d&lt;species&gt;&lt;isotope&gt;, e.g.</span>
<span class="sd">            dCH4C13, or dCO2C14</span>
<span class="sd">        - Any non-standard variables should be listed in the species_translator</span>
<span class="sd">            dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        ds: Should contain variables such as &quot;ch4&quot;, &quot;ch4 repeatability&quot;.</span>
<span class="sd">            Must have a &quot;time&quot; dimension.</span>
<span class="sd">        species: Species name. e.g. &quot;CH4&quot;, &quot;HFC-134a&quot;, &quot;dCH4C13&quot;</span>
<span class="sd">        site: Three-letter site code</span>
<span class="sd">        network: Network site is associated with</span>
<span class="sd">        global_attribuates: Dictionary containing any info you want to</span>
<span class="sd">            add to the file header (e.g. {&quot;Contact&quot;: &quot;Contact_Name&quot;})</span>
<span class="sd">        units: This routine will try to guess the units</span>
<span class="sd">            unless this is specified. Options are in units_interpret</span>
<span class="sd">        scale: Calibration scale for species.</span>
<span class="sd">        sampling_period: Number of seconds for which air</span>
<span class="sd">            sample is taken. Only for time variable attribute</span>
<span class="sd">        date_range: Start and end date for output</span>
<span class="sd">            If you only want an end date, just put a very early start date</span>
<span class="sd">            (e.g. [&quot;1900-01-01&quot;, &quot;2010-01-01&quot;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">Timestamp</span> <span class="k">as</span> <span class="n">pd_Timestamp</span>
    <span class="kn">from</span> <span class="nn">openghg.util</span> <span class="kn">import</span> <span class="n">clean_string</span><span class="p">,</span> <span class="n">load_json</span><span class="p">,</span> <span class="n">timestamp_now</span>

    <span class="c1"># from numpy import unique as np_unique</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;This function only accepts xarray Datasets&quot;</span><span class="p">)</span>

    <span class="c1"># Current CF Conventions (v1.7) demand that valid variable names</span>
    <span class="c1"># begin with a letter and be composed of letters, digits and underscores</span>
    <span class="c1"># Here variable names are also made lowercase to enable easier matching below</span>

    <span class="c1"># TODO - could I just cast ds.variables as as type for mypy instead of doing this?</span>
    <span class="c1"># variable_names = [str(v) for v in ds.variables]</span>
    <span class="c1"># Is this better?</span>
    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">to_underscores</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_names</span><span class="p">}</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">to_underscores</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="n">species_attrs</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;species_attributes.json&quot;</span><span class="p">)</span>
    <span class="n">attributes_data</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;attributes.json&quot;</span><span class="p">)</span>

    <span class="n">species_translator</span> <span class="o">=</span> <span class="n">attributes_data</span><span class="p">[</span><span class="s2">&quot;species_translation&quot;</span><span class="p">]</span>
    <span class="n">unit_species</span> <span class="o">=</span> <span class="n">attributes_data</span><span class="p">[</span><span class="s2">&quot;unit_species&quot;</span><span class="p">]</span>
    <span class="n">unit_species_long</span> <span class="o">=</span> <span class="n">attributes_data</span><span class="p">[</span><span class="s2">&quot;unit_species_long&quot;</span><span class="p">]</span>
    <span class="n">unit_interpret</span> <span class="o">=</span> <span class="n">attributes_data</span><span class="p">[</span><span class="s2">&quot;unit_interpret&quot;</span><span class="p">]</span>

    <span class="n">species_upper</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">species_lower</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">matched_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_names</span> <span class="k">if</span> <span class="n">species_lower</span> <span class="ow">in</span> <span class="n">var</span><span class="p">]</span>

    <span class="c1"># If we don&#39;t have any variables to rename, raise an error</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find species </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2"> in Dataset variables&quot;</span><span class="p">)</span>

    <span class="n">species_rename</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">matched_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">species_label</span> <span class="o">=</span> <span class="n">species_translator</span><span class="p">[</span><span class="n">species_upper</span><span class="p">][</span><span class="s2">&quot;chem&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">species_label</span> <span class="o">=</span> <span class="n">clean_string</span><span class="p">(</span><span class="n">species_lower</span><span class="p">)</span>

        <span class="n">species_rename</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">species_lower</span><span class="p">,</span> <span class="n">species_label</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">species_rename</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Global attributes</span>
    <span class="n">global_attributes_default</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;conditions_of_use&quot;</span><span class="p">:</span> <span class="s2">&quot;Ensure that you contact the data owner at the outset of your project.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;In situ measurements of air&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Conventions&quot;</span><span class="p">:</span> <span class="s2">&quot;CF-1.6&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">global_attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO - for some reason mypy doesn&#39;t see a Dict[str,str] as a valid Mapping[Hashable, Any] type</span>
        <span class="n">global_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_attributes_default</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">global_attributes</span> <span class="o">=</span> <span class="n">global_attributes_default</span>

    <span class="n">global_attributes</span><span class="p">[</span><span class="s2">&quot;file_created&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_now</span><span class="p">())</span>
    <span class="n">global_attributes</span><span class="p">[</span><span class="s2">&quot;processed_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OpenGHG_Cloud&quot;</span>
    <span class="n">global_attributes</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species_label</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">global_attributes</span><span class="p">[</span><span class="s2">&quot;calibration_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">global_attributes</span><span class="p">[</span><span class="s2">&quot;calibration_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>

    <span class="c1"># Update the Dataset attributes</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_attributes</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Add some site attributes</span>
    <span class="n">site_attributes</span> <span class="o">=</span> <span class="n">_site_info_attributes</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">network</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">site_attributes</span><span class="p">)</span>

    <span class="c1"># Species-specific attributes</span>
    <span class="c1"># Long name</span>
    <span class="k">if</span> <span class="n">species_upper</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">species_upper</span> <span class="o">!=</span> <span class="s2">&quot;DESFLURANE&quot;</span> <span class="ow">or</span> <span class="n">species_upper</span> <span class="o">==</span> <span class="s2">&quot;APD&quot;</span><span class="p">:</span>
        <span class="n">sp_long</span> <span class="o">=</span> <span class="n">species_translator</span><span class="p">[</span><span class="n">species_upper</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">species_upper</span> <span class="o">==</span> <span class="s2">&quot;RN&quot;</span><span class="p">:</span>
        <span class="n">sp_long</span> <span class="o">=</span> <span class="s2">&quot;radioactivity_concentration_of_222Rn_in_air&quot;</span>
    <span class="k">elif</span> <span class="n">species_upper</span> <span class="ow">in</span> <span class="n">species_translator</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">species_translator</span><span class="p">[</span><span class="n">species_upper</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">sp_long</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mole_fraction_of_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_in_air&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sp_long</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mole_fraction_of_</span><span class="si">{</span><span class="n">species_label</span><span class="si">}</span><span class="s2">_in_air&quot;</span>

    <span class="n">ancillary_variables</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">matched_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_names</span> <span class="k">if</span> <span class="n">species_lower</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="c1"># Write units as attributes to variables containing any of these</span>
    <span class="n">match_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;variability&quot;</span><span class="p">,</span> <span class="s2">&quot;repeatability&quot;</span><span class="p">,</span> <span class="s2">&quot;stdev&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variable_names</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">species_label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="c1"># Standard name attribute</span>
            <span class="c1"># ds[key].attrs[&quot;standard_name&quot;]=key.replace(species_label, sp_long)</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">species_label</span><span class="p">,</span> <span class="n">sp_long</span><span class="p">)</span>

            <span class="c1"># If units are required for variable, add attribute</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">species_label</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">match_words</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">unit_interpret</span><span class="p">:</span>
                        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_interpret</span><span class="p">[</span><span class="n">units</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_interpret</span><span class="p">[</span><span class="s2">&quot;else&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO - merge these species attributes into a single simpler JSON</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_species</span><span class="p">[</span><span class="n">species_upper</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species_attrs</span><span class="p">[</span><span class="n">species_label</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

                <span class="c1"># If units are non-standard, add explanation</span>
                <span class="k">if</span> <span class="n">species_upper</span> <span class="ow">in</span> <span class="n">unit_species_long</span><span class="p">:</span>
                    <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units_description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_species_long</span><span class="p">[</span><span class="n">species_upper</span><span class="p">]</span>

            <span class="c1"># Add to list of ancilliary variables</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">species_label</span><span class="p">:</span>
                <span class="n">ancillary_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># TODO - for the moment skip this step - check status of ancilliary variables in standard</span>
    <span class="c1"># Write ancilliary variable list</span>
    <span class="c1"># ds[species_label].attrs[&quot;ancilliary_variables&quot;] = &quot;, &quot;.join(ancillary_variables)</span>

    <span class="c1"># Add quality flag attributes</span>
    <span class="c1"># NOTE - I&#39;ve removed the whitespace before status_flag and integration_flag here</span>
    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">quality_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variable_names</span> <span class="k">if</span> <span class="s2">&quot;status_flag&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

    <span class="c1"># Not getting long_name for c2f6</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">quality_flags</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">long_name</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">species_label</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">quality_flags</span><span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;flag_meaning&quot;</span><span class="p">:</span> <span class="s2">&quot;0 = unflagged, 1 = flagged&quot;</span><span class="p">,</span>
            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">long_name</span><span class="si">}</span><span class="s2"> status_flag&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">variable_names</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
    <span class="c1"># Add integration flag attributes</span>
    <span class="n">integration_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variable_names</span> <span class="k">if</span> <span class="s2">&quot;integration_flag&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">integration_flags</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">long_name</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">species_label</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;flag_meaning&quot;</span><span class="p">:</span> <span class="s2">&quot;0 = area, 1 = height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;standard_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">long_name</span><span class="si">}</span><span class="s2"> integration_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;GC peak integration method (by height or by area). Does not indicate data quality&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Set time encoding</span>
    <span class="c1"># Check if there are duplicate time stamps</span>

    <span class="c1"># I feel there should be a more pandas way of doing this</span>
    <span class="c1"># but xarray doesn&#39;t currently have a duplicates method</span>
    <span class="c1"># See this https://github.com/pydata/xarray/issues/2108</span>

    <span class="c1"># if len(set(ds.time.values)) &lt; len(ds.time.values):</span>
    <span class="c1"># if len(np_unique(ds.time.values)) &lt; len(ds.time.values):</span>
    <span class="c1">#     print(&quot;WARNING. Duplicate time stamps&quot;)</span>
    <span class="n">first_year</span> <span class="o">=</span> <span class="n">pd_Timestamp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">year</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;seconds since </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">first_year</span><span class="p">)</span><span class="si">}</span><span class="s2">-01-01 00:00:00&quot;</span><span class="p">}</span>

    <span class="n">time_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">time_attributes</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>
    <span class="n">time_attributes</span><span class="p">[</span><span class="s2">&quot;standard_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">time_attributes</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Time stamp corresponds to beginning of sampling period. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;Time since midnight UTC of reference date. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;Note that sampling periods are approximate.&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sampling_period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_attributes</span><span class="p">[</span><span class="s2">&quot;sampling_period_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampling_period</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time_attributes</span><span class="p">)</span>

    <span class="c1"># If a date range is specified, slice dataset</span>
    <span class="k">if</span> <span class="n">date_range</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">date_range</span><span class="p">))]</span>

    <span class="k">return</span> <span class="n">ds</span></div>


<span class="k">def</span> <span class="nf">_site_info_attributes</span><span class="p">(</span><span class="n">site</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reads site attributes from JSON</span>

<span class="sd">    Args:</span>
<span class="sd">        site: Site code</span>
<span class="sd">        network: Network name</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary of site attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">openghg.util</span> <span class="kn">import</span> <span class="n">load_json</span>

    <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># Read site info file</span>
    <span class="n">data_filename</span> <span class="o">=</span> <span class="s2">&quot;acrg_site_info.json&quot;</span>
    <span class="n">site_params</span> <span class="o">=</span> <span class="n">load_json</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">network</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">network</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">site_params</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">attributes_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;station_longitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;station_latitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;station_long_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;height_station_masl&quot;</span><span class="p">:</span> <span class="s2">&quot;station_height_masl&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">site_params</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">site_params</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">network</span><span class="p">]:</span>
                <span class="n">attr_key</span> <span class="o">=</span> <span class="n">attributes_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

                <span class="n">attributes</span><span class="p">[</span><span class="n">attr_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_params</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">network</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid site </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2"> passed. Please use a valid site code such as BSD for Bilsdale&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">attributes</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022 OpenGHG development team.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>