name: OpenGHG tests

on:
  push:
    branches: [master, devel]
    tags:
      - "*"
    paths-ignore:
      - 'CHANGELOG.md'
  pull_request:
    branches: [master, devel]
    paths-ignore:
      - 'CHANGELOG.md'

jobs:
  release_conda:

    name: Build and publish conda package
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@875557da4ee020f18df03b8910a42203fbf02da1
        with:
          init-shell: bash
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          TAG=$(git fetch --tags && git tag -l | tail -n 1)
          echo "Latest tag is $TAG"
          echo "::set-output name=TAG::$TAG"
      - name: Build and push the conda package
        run: |

          micromamba create -n openghg_build anaconda-client boa conda-verify -c conda-forge
          micromamba activate openghg_build
          conda config --append channels openghg
          mkdir ${{ github.workspace }}/build
          conda mambabuild --croot ${{ github.workspace }}/build recipes -c conda-forge
          BUILD_DIR=${GITHUB_WORKSPACE}/build
          BUILD=$(find "$BUILD_DIR" -name '*.tar.bz2')
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
          GIT_TAG: ${{ steps.get_tag.outputs.TAG }}