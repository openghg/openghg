name: Conda Release

on:
  push:
    branches:
      - "conda-release"
  pull_request:
    branches:
      - "devel"
  workflow_dispatch:

jobs:
  release_conda:
    name: Fetch latest tag and build conda package
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch latest Git tag
        id: get_latest_tag
        run: |
          git fetch --tags
          # Get the latest tag even if the current branch is ahead
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "Using Git tag: $LATEST_TAG"
        env:
          GIT_TAG: ${{ env.LATEST_TAG }}

      - name: Load environment variables
        run: source $GITHUB_ENV

      - uses: mamba-org/setup-micromamba@v1
        with:
          init-shell: bash

      - name: Install conda dependencies
        run: |
          micromamba create -n openghg_build anaconda-client boa conda-verify -c conda-forge
          micromamba activate openghg_build
          conda install anaconda-client -y

      - name: Build the conda package
        run: |
          micromamba activate openghg_build
          conda config --append channels openghg
          mkdir ${{ github.workspace }}/build
          conda mambabuild --croot ${{ github.workspace }}/build recipes -c conda-forge
        env:
          GIT_TAG: ${{ env.LATEST_TAG }}  # Pass GIT_TAG to conda build

      - name: Publish to Anaconda
        run: |
          micromamba activate openghg_build
          BUILD_DIR=${GITHUB_WORKSPACE}/build
          BUILD=$(find "$BUILD_DIR" -name '*.tar.bz2')
          anaconda --token "$ANACONDA_TOKEN" upload --user openghg --label main "$BUILD"
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN_EXP_2025_08_14 }}
          GIT_TAG: ${{ env.LATEST_TAG }}
