
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fn Development &#8212; OpenGHG 0.9.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=db7899ab" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=39bb1c6d"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'development/cloud/fn_devel';</script>
    <script src="../../_static/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Aug 14, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/OpenGHG_Logo_NoText.png" class="logo__image only-light" alt="OpenGHG 0.9.0 documentation - Home"/>
    <script>document.write(`<img src="../../_static/OpenGHG_Logo_NoText.png" class="logo__image only-dark" alt="OpenGHG 0.9.0 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    User API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index_devel.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index_devapi.html">
    Developer API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../install.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index.html">
    User API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index_devel.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/index_devapi.html">
    Developer API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Fn Development</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="fn-development">
<h1>Fn Development<a class="headerlink" href="#fn-development" title="Link to this heading">#</a></h1>
<p>Fn is an open-source framework for creating a Functions-as-a-Service (FaaS) compute platform. In real terms this means
we make a HTTP POST call to our Fn server, ask it to call a function which then returns a result.</p>
<section id="getting-setup">
<h2>Getting setup<a class="headerlink" href="#getting-setup" title="Link to this heading">#</a></h2>
<p>To run through this tutorial you must have both Docker and Fn.</p>
<p>For Docker installation instructions please visit <a class="reference external" href="https://docs.docker.com/get-docker/">the Docker installation instruction</a>.</p>
<p>To install Fn follow the instructions for your operating system given on <a class="reference external" href="https://github.com/fnproject/fn">their GitHub repo</a>.</p>
</section>
<section id="starting-fn">
<h2>Starting Fn<a class="headerlink" href="#starting-fn" title="Link to this heading">#</a></h2>
<p>As we’ll be developing functions locally we’ll want to start up an instance of <code class="docutils literal notranslate"><span class="pre">Fn</span></code> to allow us to run (invoke) the functions
we build. During development setting the log level of <code class="docutils literal notranslate"><span class="pre">Fn</span></code> to <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> is highly recommended. This pipes errors that may occur
within the containers to the terminal. Without setting the log level the only error reporting shown is a less helpful
<code class="docutils literal notranslate"><span class="pre">Error</span> <span class="pre">invoking</span> <span class="pre">function.</span> <span class="pre">status:</span> <span class="pre">502</span> <span class="pre">message:</span> <span class="pre">function</span> <span class="pre">failed</span></code> message.</p>
<p>So, open a terminal and run (and leave running)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>start<span class="w"> </span>--log-level<span class="w"> </span>DEBUG
</pre></div>
</div>
<p>If you don’t want extra debug information from each invocation just run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>start
</pre></div>
</div>
</section>
<section id="first-function">
<h2>First function<a class="headerlink" href="#first-function" title="Link to this heading">#</a></h2>
<p>To call functions within OpenGHG we use a routing function with Fn. This function (link to route.py) routes calls made to
our Fn triggers (more on triggers later). To setup a function we first need to create an app. To do this we use</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>init<span class="w"> </span>--runtime<span class="w"> </span>python<span class="w"> </span>openghg_fn
</pre></div>
</div>
<p>This will create a folder called <code class="docutils literal notranslate"><span class="pre">openghg_fn</span></code> with some boilerplate code inside. These can form a template
for creation of your own functions. If we look inside this directory we’ll see three files</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>openghg_fn/
$<span class="w"> </span>ls
func.py<span class="w">  </span>func.yaml<span class="w">  </span>requirements.txt
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">func.py</span></code> is the function we’re going to call, <code class="docutils literal notranslate"><span class="pre">func.yaml</span></code> tells Fn how to setup and run the function and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>
contains the Python requirements and is used when a Docker image is built for the function.</p>
<section id="function-code">
<h3>Function code<a class="headerlink" href="#function-code" title="Link to this heading">#</a></h3>
<p>First we’ll modify <code class="docutils literal notranslate"><span class="pre">func.py</span></code> to contain a simple response to being called. Paste the following into <code class="docutils literal notranslate"><span class="pre">func.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">fdk.response</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello from OpenGHG&quot;</span><span class="p">}</span>
    <span class="n">return_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">response_data</span><span class="o">=</span><span class="n">return_str</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="function-parameters">
<h3>Function parameters<a class="headerlink" href="#function-parameters" title="Link to this heading">#</a></h3>
<p>Next we’ll modify <code class="docutils literal notranslate"><span class="pre">func.yaml</span></code> to contain</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">schema_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20180708</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openghg_fn</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.1</span>
<span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/python/bin/fdk /function/func.py route</span>
<span class="c1"># Memory limit for function in MB</span>
<span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
</pre></div>
</div>
<p>Here note the change of <code class="docutils literal notranslate"><span class="pre">handler</span></code> to <code class="docutils literal notranslate"><span class="pre">route</span></code> for the entrypoint.</p>
<p>Seeing as we’re just using a bare Fn function here we can leave <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> as it is with our only requirement being <code class="docutils literal notranslate"><span class="pre">fdk</span></code>.
As each function needs to be part of an app we create an app called <code class="docutils literal notranslate"><span class="pre">openghg</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>create<span class="w"> </span>app<span class="w"> </span>openghg
</pre></div>
</div>
<p>We’re now ready to deploy our function and call it.</p>
</section>
<section id="deployment">
<h3>Deployment<a class="headerlink" href="#deployment" title="Link to this heading">#</a></h3>
<p>To deploy the app we can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>--verbose<span class="w"> </span>deploy<span class="w"> </span>--local
</pre></div>
</div>
<p>This tells Fn give us verbose output and <code class="docutils literal notranslate"><span class="pre">--local</span></code> tells it not to push our Docker image to DockerHub. After you run this command
you’ll see a lot of output as Fn builds a Docker. Hopefully at the end of the output you’ll have something similar to</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Successfully<span class="w"> </span>built<span class="w"> </span>22ed08c1f99e
Successfully<span class="w"> </span>tagged<span class="w"> </span>openghg_fn:0.0.2

Updating<span class="w"> </span><span class="k">function</span><span class="w"> </span>openghg_fn<span class="w"> </span>using<span class="w"> </span>image<span class="w"> </span>openghg_fn:0.0.2...
Successfully<span class="w"> </span>created<span class="w"> </span><span class="k">function</span>:<span class="w"> </span>openghg_fn<span class="w"> </span>with<span class="w"> </span>openghg_fn:0.0.2
</pre></div>
</div>
<p>Don’t worry if some values are slightly different here.</p>
</section>
<section id="call">
<h3>Call<a class="headerlink" href="#call" title="Link to this heading">#</a></h3>
<p>You should then be able to invoke / call the function using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>openghg_fn<span class="o">]</span>$<span class="w"> </span>fn<span class="w"> </span>invoke<span class="w"> </span>openghg<span class="w"> </span>openghg_fn
<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;Hello from OpenGHG&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">curl</span></code> to trigger the function. If we do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>openghg_fn<span class="o">]</span>$<span class="w"> </span>fn<span class="w"> </span>inspect<span class="w"> </span><span class="k">function</span><span class="w"> </span>openghg<span class="w"> </span>openghg_fn
<span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;annotations&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;fnproject.io/fn/invokeEndpoint&quot;</span>:<span class="w"> </span><span class="s2">&quot;http://localhost:8080/invoke/01ES9D6TA5NG8G00GZJ0000009&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;app_id&quot;</span>:<span class="w"> </span><span class="s2">&quot;01ES9D6T23NG8G00GZJ0000008&quot;</span>,
<span class="w">    </span><span class="s2">&quot;created_at&quot;</span>:<span class="w"> </span><span class="s2">&quot;2020-12-11T17:22:35.461Z&quot;</span>,
<span class="w">    </span><span class="s2">&quot;id&quot;</span>:<span class="w"> </span><span class="s2">&quot;01ES9D6TA5NG8G00GZJ0000009&quot;</span>,
<span class="w">    </span><span class="s2">&quot;idle_timeout&quot;</span>:<span class="w"> </span><span class="m">30</span>,
<span class="w">    </span><span class="s2">&quot;image&quot;</span>:<span class="w"> </span><span class="s2">&quot;openghg:0.0.82&quot;</span>,
<span class="w">    </span><span class="s2">&quot;memory&quot;</span>:<span class="w"> </span><span class="m">2048</span>,
<span class="w">    </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;openghg&quot;</span>,
<span class="w">    </span><span class="s2">&quot;timeout&quot;</span>:<span class="w"> </span><span class="m">30</span>,
<span class="w">    </span><span class="s2">&quot;updated_at&quot;</span>:<span class="w"> </span><span class="s2">&quot;2021-06-08T13:26:48.066Z&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We can see that there is an invocation endpoint at <code class="docutils literal notranslate"><span class="pre">http://localhost:8080/invoke/01ES9D6TA5NG8G00GZJ0000009</span></code>, using curl we can
call the function like so</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>openghg_fn<span class="o">]</span>$<span class="w"> </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:8080/invoke/01ES9D6TA5NG8G00GZJ0000009
<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;Hello from OpenGHG&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>Note that your invocation endpoint may differ slightly from the one shown above.</p>
</section>
</section>
<section id="dockerise">
<h2>Dockerise<a class="headerlink" href="#dockerise" title="Link to this heading">#</a></h2>
<p>As our functions will be more complex than the example given above we need to create our own custom Docker image.
To create our own Docker image for the function we’ve created above create a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> in the <code class="docutils literal notranslate"><span class="pre">openghg_fn</span></code> folder
that contains the following:</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">fnproject/python:3.8.5</span>

<span class="k">ADD</span><span class="w"> </span>requirements.txt<span class="w"> </span>func.py<span class="w"> </span><span class="k">function</span>/
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/function</span>

<span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span><span class="nv">pip</span><span class="o">==</span><span class="m">20</span>.2.4<span class="w"> </span>wheel<span class="w"> </span>setuptools
<span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>--target<span class="w"> </span>/python/<span class="w"> </span>-r<span class="w"> </span>requirements.txt
<span class="k">RUN</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>requirements.txt

<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/python

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/python/bin/fdk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/function/func.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;route&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Here we’ve installed a specific <code class="docutils literal notranslate"><span class="pre">pip</span></code> version 20.2.4 as this was the last version before the new resolver was introduced.</p>
<p>After creating our <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> we must also update <code class="docutils literal notranslate"><span class="pre">func.yaml</span></code> to create tell Fn that we’re now using our own customer Docker container</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">schema_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20180708</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openghg_fn</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.4</span>
<span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<span class="nt">triggers</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/openghg_fn</span>
</pre></div>
</div>
<p>We can then tell Fn to deploy the image again. This will build the container using our custom Dockerfile.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fn<span class="w"> </span>--verbose<span class="w"> </span>deploy<span class="w"> </span>--local
</pre></div>
</div>
<p>Hopefully at the end of the build you’ll see something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Updating<span class="w"> </span><span class="k">function</span><span class="w"> </span>openghg_fn<span class="w"> </span>using<span class="w"> </span>image<span class="w"> </span>openghg_fn:0.0.4...
Successfully<span class="w"> </span>created<span class="w"> </span>trigger:<span class="w"> </span>route
Trigger<span class="w"> </span>Endpoint:<span class="w"> </span>http://localhost:8080/t/openghg/openghg_fn
</pre></div>
</div>
<p>We now have a much cleaner endpoint we can use to trigger the function. Using <code class="docutils literal notranslate"><span class="pre">curl</span></code> again to trigger the function. Note that
trigger/invoke/call are all used interchangeably here.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>openghg_fn<span class="o">]</span>$<span class="w"> </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:8080/t/openghg/openghg_fn
<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="w"> </span><span class="s2">&quot;Hello from OpenGHG&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>Now we have an understanding of how Fn works and how to create functions and call them we will cover the functions available in OpenGHG.</p>
</section>
<section id="openghg-functions">
<h2>OpenGHG functions<a class="headerlink" href="#openghg-functions" title="Link to this heading">#</a></h2>
<p>With OpenGHG we use a single routing function to route calls to a number of separate functions. This routing function can be found
in <code class="docutils literal notranslate"><span class="pre">services/route.py</span></code>. To use this routing function we first need to setup a Docker container within which we can perform the
computation and return the data to the caller. As OpenGHG requires a number of packages we use a two step build process.
First we create a base image, called <code class="docutils literal notranslate"><span class="pre">openghg-base</span></code> which contains all the requirements for OpenGHG. We then use this base image
to create a second image, called <code class="docutils literal notranslate"><span class="pre">openghg-complete</span></code>, into which we copy our OpenGHG library code and services/function code.</p>
<section id="base-image">
<h3>Base image<a class="headerlink" href="#base-image" title="Link to this heading">#</a></h3>
<p>First we’ll look at the base image which can be found in <code class="docutils literal notranslate"><span class="pre">docker/base_image</span></code>. This folder contains a Python script
that makes building the image easier and a Dockerfile.</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">fnproject/python:3.8.5-dev</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build-stage</span>

<span class="k">ADD</span><span class="w"> </span>requirements-server.txt<span class="w"> </span>./

<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span>-y
<span class="c"># pip 20.2.4 is the version before the new resolver was introduced</span>
<span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span><span class="nv">pip</span><span class="o">==</span><span class="m">20</span>.2.4<span class="w"> </span>wheel<span class="w"> </span>setuptools<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>pip3<span class="w"> </span>install<span class="w"> </span>--target<span class="w"> </span>/python/<span class="w"> </span>-r<span class="w"> </span>requirements-server.txt

<span class="k">FROM</span><span class="w"> </span><span class="s">fnproject/python:3.8.5</span>

<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>build-stage<span class="w"> </span>/python/<span class="w"> </span>/python/
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/python

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> is very similar to the one shown above. Some differences are that we copy an extra requirements file into the image
and install <code class="docutils literal notranslate"><span class="pre">git</span></code> to allow <code class="docutils literal notranslate"><span class="pre">pip</span></code> to install Acquire from GitHub. Another difference is that we use two build stages. The first using
the <code class="docutils literal notranslate"><span class="pre">fnproject/python:3.8.5-dev</span> <span class="pre">as</span> <span class="pre">build-stage</span></code>. After cloning Acquire and installing all the packages into <code class="docutils literal notranslate"><span class="pre">/python</span></code> we start
with a fresh image and copy only the contents of <code class="docutils literal notranslate"><span class="pre">/python</span></code> into this image. This helps limit the size of the image.</p>
<p>To build this image run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>build.py
</pre></div>
</div>
<p>This will build a Docker image with the tag <code class="docutils literal notranslate"><span class="pre">openghg/openghg-base:latest</span></code>. To see the available options when building the image
run the command above with <code class="docutils literal notranslate"><span class="pre">-h</span></code>.</p>
</section>
<section id="complete-image">
<h3>Complete image<a class="headerlink" href="#complete-image" title="Link to this heading">#</a></h3>
<p>Now we’ve built the base image we can build the complete image containing the OpenGHG library and services code. The files to build this image
can be found in <code class="docutils literal notranslate"><span class="pre">docker/</span></code>. It contains <code class="docutils literal notranslate"><span class="pre">func.yaml</span></code> which tells Fn how to run our function. The <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> (shown below) uses
the <code class="docutils literal notranslate"><span class="pre">openghg-base</span></code> image we build in the previous step, adding <code class="docutils literal notranslate"><span class="pre">route.py</span></code> to the <code class="docutils literal notranslate"><span class="pre">/function</span></code> folder and then copying the OpenGHG
code into <code class="docutils literal notranslate"><span class="pre">/python</span></code>. We also copy the services code which form the functions that calls are routed to by <code class="docutils literal notranslate"><span class="pre">route.py</span></code>.</p>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">openghg/openghg-base:latest</span>

<span class="k">ADD</span><span class="w"> </span>openghg_services/route.py<span class="w"> </span>/function/
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/function</span>

<span class="c"># Copy in openghg</span>
<span class="k">ADD</span><span class="w"> </span>openghg<span class="w"> </span>/python/openghg
<span class="k">RUN</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>compileall<span class="w"> </span>/python/openghg/*

<span class="c"># Copy in the service files</span>
<span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/python/openghg_services
<span class="k">ADD</span><span class="w"> </span>openghg_services<span class="w"> </span>/python/openghg_services
<span class="k">RUN</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>compileall<span class="w"> </span>/python/openghg_services/*.py

<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/python
<span class="k">ENV</span><span class="w"> </span><span class="nv">OPENGHG_CLOUD</span><span class="o">=</span><span class="m">1</span>
<span class="c"># Become the $FN_USER so that nothing runs as root</span>
<span class="k">USER</span><span class="w"> </span><span class="s">$FN_USER</span>

<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/python/bin/fdk&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/function/route.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;handle_invocation&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>We have also modified <code class="docutils literal notranslate"><span class="pre">func.yaml</span></code> to increase the amount of memory available to this function to 2048 MB / 2 GB. If you notice functions failing unexpectedly
it may be worth trying changing this value.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">schema_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20180708</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openghg</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.100</span>
<span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2048</span>
<span class="nt">triggers</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
</pre></div>
</div>
<p>To build this image we use the <code class="docutils literal notranslate"><span class="pre">build_deploy.py</span></code> Python script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>docker<span class="o">]</span>$<span class="w"> </span>python<span class="w"> </span>build_deploy.py<span class="w"> </span>-h
usage:<span class="w"> </span>build_deploy.py<span class="w"> </span><span class="o">[</span>-h<span class="o">]</span><span class="w"> </span><span class="o">[</span>--tag<span class="w"> </span>TAG<span class="o">]</span><span class="w"> </span><span class="o">[</span>--push<span class="o">]</span><span class="w"> </span><span class="o">[</span>--build<span class="o">]</span><span class="w"> </span><span class="o">[</span>--deploy<span class="o">]</span><span class="w"> </span><span class="o">[</span>--build-base<span class="o">]</span>

Build<span class="w"> </span>the<span class="w"> </span>base<span class="w"> </span>Docker<span class="w"> </span>image<span class="w"> </span>and<span class="w"> </span>optionally<span class="w"> </span>push<span class="w"> </span>to<span class="w"> </span>DockerHub

optional<span class="w"> </span>arguments:
-h,<span class="w"> </span>--help<span class="w">    </span>show<span class="w"> </span>this<span class="w"> </span><span class="nb">help</span><span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span><span class="nb">exit</span>
--tag<span class="w"> </span>TAG<span class="w">     </span>tag<span class="w"> </span>name/number,<span class="w"> </span>examples:<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span>or<span class="w"> </span>latest.<span class="w"> </span>Not<span class="w"> </span>full<span class="w"> </span>tag<span class="w"> </span>name<span class="w"> </span>such<span class="w"> </span>as<span class="w"> </span>openghg/openghg-complete:latest.<span class="w"> </span>Default:<span class="w"> </span>latest
--push<span class="w">        </span>push<span class="w"> </span>the<span class="w"> </span>image<span class="w"> </span>to<span class="w"> </span>DockerHub
--build<span class="w">       </span>build<span class="w"> </span>the<span class="w"> </span>docker<span class="w"> </span>image.<span class="w"> </span>Disables<span class="w"> </span>Fn<span class="w"> </span>deploy.
--deploy<span class="w">      </span>buid<span class="w"> </span>image<span class="w"> </span>and<span class="w"> </span>deploy<span class="w"> </span>the<span class="w"> </span>Fn<span class="w"> </span>functions
--build-base<span class="w">  </span>build<span class="w"> </span>the<span class="w"> </span>base<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>before<span class="w"> </span>building<span class="w"> </span>the<span class="w"> </span><span class="nb">complete</span><span class="w"> </span>image
</pre></div>
</div>
<p>This script takes care of building the base image as well if you want it to. To build both the base and complete image and deploy the
functions to Fn run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>build.py<span class="w"> </span>--build-base
</pre></div>
</div>
<p>If you have the base image built and have only made changes to the OpenGHG code you can just run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>build.py
</pre></div>
</div>
<p><strong>Note</strong> - if you’ve made changes to either <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> or <code class="docutils literal notranslate"><span class="pre">requirements-server.txt</span></code> you’ll need to do a rebuild of the base
image. This ensures all dependencies are installed in the base image.</p>
</section>
</section>
<section id="test-a-function">
<h2>Test a function<a class="headerlink" href="#test-a-function" title="Link to this heading">#</a></h2>
<p>Say we want to test a function such as the <code class="docutils literal notranslate"><span class="pre">testconnection</span></code> function that is a part of OpenGHG. This simple function returns a simple
string of the timestamp at which the function was called to the user.</p>
<p>As above we inspect the funtion and find its endpoint.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>user@computer<span class="w"> </span>openghg_fn<span class="o">]</span>$<span class="w"> </span>fn<span class="w"> </span>inspect<span class="w"> </span><span class="k">function</span><span class="w"> </span>openghg<span class="w"> </span>openghg
<span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;annotations&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;fnproject.io/fn/invokeEndpoint&quot;</span>:<span class="w"> </span><span class="s2">&quot;http://localhost:8080/invoke/01ES9D6TA5NG8G00GZJ0000009&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;app_id&quot;</span>:<span class="w"> </span><span class="s2">&quot;01ES9D6T23NG8G00GZJ0000008&quot;</span>,
<span class="w">    </span><span class="s2">&quot;created_at&quot;</span>:<span class="w"> </span><span class="s2">&quot;2020-12-11T17:22:35.461Z&quot;</span>,
<span class="w">    </span><span class="s2">&quot;id&quot;</span>:<span class="w"> </span><span class="s2">&quot;01ES9D6TA5NG8G00GZJ0000009&quot;</span>,
<span class="w">    </span><span class="s2">&quot;idle_timeout&quot;</span>:<span class="w"> </span><span class="m">30</span>,
<span class="w">    </span><span class="s2">&quot;image&quot;</span>:<span class="w"> </span><span class="s2">&quot;openghg:0.0.82&quot;</span>,
<span class="w">    </span><span class="s2">&quot;memory&quot;</span>:<span class="w"> </span><span class="m">2048</span>,
<span class="w">    </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;openghg&quot;</span>,
<span class="w">    </span><span class="s2">&quot;timeout&quot;</span>:<span class="w"> </span><span class="m">30</span>,
<span class="w">    </span><span class="s2">&quot;updated_at&quot;</span>:<span class="w"> </span><span class="s2">&quot;2021-06-08T13:26:48.066Z&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We can then call the function using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;function&quot; : &quot;testconnection&quot;, &quot;args&quot;: {}}&#39;</span><span class="w"> </span>http://localhost:8080/invoke/01ES9D6TA5NG8G00GZJ0000009
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Your endpoint URL will differ from the one above.</p>
</div>
<p>And we should recieve a response such as</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">{</span><span class="s1">&#39;results&#39;</span>:<span class="w"> </span><span class="s1">&#39;Function run at 2021-06-08 13:34:17.095579+00:00&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>Now we know our Dockerised function can be called and works correctly.</p>
</section>
<section id="calling-from-openghg">
<h2>Calling from OpenGHG<a class="headerlink" href="#calling-from-openghg" title="Link to this heading">#</a></h2>
<p>For information on how we’ve setup calling functions from OpenGHG please see the <a class="reference internal" href="fn_usage.html"><span class="doc">Fn usage</span></a> section of the documentation.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-setup">Getting setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-fn">Starting Fn</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-function">First function</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-code">Function code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-parameters">Function parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment">Deployment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#call">Call</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dockerise">Dockerise</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#openghg-functions">OpenGHG functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#base-image">Base image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#complete-image">Complete image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-a-function">Test a function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calling-from-openghg">Calling from OpenGHG</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024 OpenGHG development team.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>